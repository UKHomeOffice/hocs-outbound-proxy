---
kind: pipeline
type: kubernetes
name: deploy tag
trigger:
  event:
    - tag
  branch:
    - main

steps:

  - name: kube config
    image: quay.io/ukhomeofficedigital/kd
    environment:
      KUBE_CLUSTER: acp-notprod
      KUBE_NAMESPACE: cs-dev
      KUBE_SERVER: https://kube-api-notprod.notprod.acp.homeoffice.gov.uk
      KUBE_TOKEN:
        from_secret: cs_notprod
    commands:
      - ./setup-kube.sh
    volumes:
      - name: kube
        path: /root/.kube
    depends_on:
      - clone

  - &deploy
    name: cs-dev
    image: alpine/helm
    environment:
      VERSION: "${DRONE_TAG}"
    commands:
      - ./deploy.sh
    volumes:
      - name: kube
        path: /root/.kube
    depends_on:
      - kube config

  - <<: *deploy
    name wcs-dev

volumes:
  - name: kube
    temp: {}
